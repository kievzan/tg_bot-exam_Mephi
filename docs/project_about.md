# Chuser Bot project description

Проект "Chuser Bot" представляет собой Telegram-бот, который принимает файл(ы) экспорта истории чата и формирует список участников этого чата.

## Структура проекта

- `ChuserBotApplication.java` – точка входа приложения (инициализация бота и инфраструктуры).

- `analyser/` – логика анализа/агрегации данных экспорта: извлечение участников, подсчёт, фильтрация и бизнес‑правила.

- `domain/` – доменная модель: сущности пользователей, сообщений, чатов, упоминаний, отчётов и т.п.

- `parser/` – парсер файлов экспорта Telegram.

- `export/` – выходные данные (текстовые/Excel отчеты).

- `tg/` – интеграция с TelegramBots: обработчики апдейтов, команд, получение/передача файлов/документов.

- `config/` – конфигурация приложения.

- `src/test/java/ru/kievsan/chuserbot` – модульные/интеграционные тесты для парсера, анализа и прочих компонентов.

- `src/test/resources` – тестовые данные.

## Общее описание процесса

Пошаговое описание:
1. Получение от пользователя сообщений и вложений: Telegram-клиент отправляет файлы экспорта в чат с ботом.
2. Бот получает ссылки на эти файлы от Bot API.
3. Проверки: валидность формата и соответствие поддерживаемым типам экспорта (только JSON-файлы).
4. После валидации реализуется парсинг файлов.
5. На следующих шагах происходит агрегация данных: строится множество уникальных участников, находятся и связываются упоминания, отбрасываются удалённые аккаунты и формируется итоговая структура результата.
6. Выполняется генерация результата: в зависимости от общего количества уникальных сущностей (участники + упоминания) создается либо текстовый список, либо Excel‑файл. Если общее число сущностей меньше или равно 50, генерируется текстовый список и отправляется пользователю как обычное сообщение, если больше или равно 51 — генерируется Excel‑файл и отправляется как документ. Все данные обрабатываются в памяти и не сохраняются на диск.

## Архитектура

В основе проекта лежит многослойная архитектура, разделяющая интеграцию с Telegram, доменную логику (парсинг и анализ) и слой представления результатов (генерация текстов и Excel‑отчётов).

Telegram‑бот, реализованный через библиотеку TelegramBots и режим long polling, получает обновления от Telegram API и передаёт их в сервис обработки, который последовательно вызывает парсер экспорта, сервис анализа чатов и генератор отчётов.

Доменная модель описывает сущности чата, участников, упоминаний и итогового аналитического результата, что позволяет изолировать бизнес‑логику от деталей транспорта и хранилища.

## Взаимодействие

Сервис обработки последовательно вызывает парсер (который возвращает структурированный экспорт), затем сервис анализа (формирующий объект результата анализа — список участников, упоминаний и т.д.), и наконец генератор отчётов (который создаёт либо текстовый список, либо Excel‑файл в зависимости от общего количества сущностей — участники + упоминания). Бот отправляет результат обратно через Bot API, после чего пользователь получает сообщение или документ в своём Telegram‑клиенте. Такая последовательность подчёркивает чёткое разделение ролей: Telegram обеспечивает транспорт, бот‑обёртка отвечает за протокол и оркестрацию, а специализированные сервисы – за бизнес‑логику анализа и представления данных.

## Модель

Отдельный класс Telegram‑бота реализует интерфейсы TelegramBots и отвечает за приём обновлений и идентификацию бота (имя и токен).

Сервис обработки обновлений (chat‑processing) выступает оркестратором над тремя основными сервисами: парсером экспорта, сервисом анализа чатов и генератором отчётов; он получает доменные объекты от парсера, передаёт их в анализ, затем генератор отчётов создаёт либо текстовый список, либо Excel‑файл в зависимости от общего количества сущностей (участники + упоминания), и отправляет результат пользователю.

## Развёртывание

Три основные стороны: клиентское устройство с приложением Telegram, облачная инфраструктура Telegram Bot API и сервер, на котором работает контейнер chatlas-bot.

Проект развёртывается как Java‑приложение (Java 21 + Maven), упакованное в Docker‑контейнер, что облегчает запуск в разных средах (локальная разработка, учебный сервер, облачный хостинг).

Контейнер получает токен бота через .env‑файл или переменные окружения, использует стандартный вывод/логирование SLF4J для регистрации событий и устанавливает исходящие соединения к Telegram API по протоколу HTTPS для получения обновлений и отправки ответов.

Коммуникация организована по схеме long polling: контейнер периодически обращается к Bot API методом получения обновлений. Таким образом, для запуска достаточно работающего Docker‑демона и корректно установленного токена, без дополнительного конфигурирования nginx / прокси.

